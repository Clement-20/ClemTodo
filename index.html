<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clem Todo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .task-done {
            text-decoration: line-through;
            color: #94a3b8; /* Slate gray */
        }
        .delete-btn {
            color: #f87171; /* Red 400 */
        }
        .delete-btn:hover {
            color: #ef4444; /* Red 500 */
        }
        /* Custom spinner for Clem Bot */
        .dot-spinner {
            width: 44px;
            height: 44px;
            display: grid;
            animation: dot-spinner-rotate 1.2s infinite;
        }
        .dot-spinner::before,
        .dot-spinner::after {
            content: "";
            grid-area: 1/1;
            border-radius: 50%;
            background: #a855f7; /* Violet 500 */
            animation: dot-spinner-pulse 1.2s infinite;
        }
        .dot-spinner::before {
            --position: -70%;
        }
        .dot-spinner::after {
            --position: 70%;
        }
        @keyframes dot-spinner-rotate {
            100% { transform: rotate(360deg) }
        }
        @keyframes dot-spinner-pulse {
            0%, 100% { opacity: 1; transform: translate(var(--position, 0)) scale(1) }
            50% { opacity: .5; transform: translate(0) scale(.8) }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- SPLASH SCREEN -->
    <div id="splashScreen" class="fixed inset-0 z-50 bg-indigo-700 flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <div class="animate-pulse flex flex-col items-center text-white">
            <div class="text-6xl mb-4 transform rotate-6">âš¡</div>
            <h1 class="text-5xl font-extrabold tracking-tight">Clem Todo</h1>
            <p class="mt-4 text-lg font-light">Loading your cloud tasks...</p>
        </div>
    </div>

    <!-- Main Container (Initially hidden) -->
    <div id="mainApp" class="w-full max-w-lg bg-white shadow-2xl shadow-indigo-200 rounded-3xl p-6 md:p-10 opacity-0 transition-opacity duration-500 ease-in-out">
        <header class="text-center mb-6">
            <div class="flex items-center justify-center space-x-2 mb-2">
                <div class="text-4xl text-indigo-500 transform rotate-[-10deg]">âš¡</div>
                <h1 class="text-4xl font-black text-gray-900 tracking-tighter">Clem Todo</h1>
            </div>
            <p class="text-sm text-indigo-400 font-medium">Get it done.</p>
        </header>

        <!-- Clem Bot Section -->
        <div class="bg-violet-50 p-4 rounded-xl mb-6 shadow-inner">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold text-violet-700 flex items-center">
                    ðŸ¤– Clem Bot <span class="text-xs font-normal text-violet-400 ml-2">(Task Assigning AI)</span>
                </h2>
                <button id="clemBotTrigger"
                        class="bg-violet-500 hover:bg-violet-600 text-white text-sm font-semibold py-2 px-4 rounded-full transition duration-150 transform active:scale-95 disabled:bg-violet-300 shadow-md">
                    Suggest Task
                </button>
            </div>
            <div id="clemBotOutput" class="min-h-8 text-sm text-gray-700">
                <!-- AI task suggestion will appear here -->
                <p>Click 'Suggest Task' to get a new idea from Clem Bot.</p>
            </div>
        </div>

        <!-- Task Input Form -->
        <div class="flex space-x-2 mb-8">
            <input type="text" id="taskInput" placeholder="Enter a task to focus on..."
                   class="flex-grow p-4 border-2 border-indigo-200 rounded-xl focus:outline-none focus:border-indigo-500 transition duration-150 shadow-sm text-gray-800">
            <button id="addTaskBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-5 rounded-xl shadow-lg shadow-indigo-300 transition duration-150 ease-in-out transform active:scale-95 disabled:bg-indigo-400">
                +
            </button>
        </div>

        <!-- Task List Container -->
        <div id="taskList" class="space-y-3">
            <div id="loadingIndicator" class="text-center text-gray-500 p-8">
                <div class="dot-spinner mx-auto mb-2"></div>
                Connecting to cloud...
            </div>
        </div>

        <!-- Footer Info -->
        <div class="mt-8 pt-4 border-t border-gray-100">
            <p class="text-xs text-gray-400 break-words text-center">
                User ID: <span id="userIdDisplay" class="font-mono text-gray-500">Loading...</span>
            </p>
        </div>
    </div>

    <!-- Error/Status Message Box -->
    <div id="statusMessage" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-3 bg-red-500 text-white text-sm rounded-lg shadow-xl hidden z-40"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONFIGURATION & DOM ELEMENTS ---

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let unsubscribeTasks = null;
        let authReady = false;

        const splashScreenEl = document.getElementById('splashScreen');
        const mainAppEl = document.getElementById('mainApp');
        const taskListEl = document.getElementById('taskList');
        const taskInputEl = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessageEl = document.getElementById('statusMessage');
        const clemBotTrigger = document.getElementById('clemBotTrigger');
        const clemBotOutput = document.getElementById('clemBotOutput');

        const API_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=`;

        // --- UTILITIES ---

        function showStatus(message, isError = false) {
            statusMessageEl.textContent = message;
            statusMessageEl.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            statusMessageEl.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            statusMessageEl.classList.remove('opacity-0');
            statusMessageEl.classList.add('opacity-100');
            clearTimeout(statusMessageEl.timer);
            statusMessageEl.timer = setTimeout(() => {
                statusMessageEl.classList.add('hidden');
            }, 4000);
        }

        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- SPLASH SCREEN & UI HANDLING ---

        function hideSplashScreen() {
            splashScreenEl.style.opacity = '0';
            setTimeout(() => {
                splashScreenEl.classList.add('hidden');
                mainAppEl.style.opacity = '1';
                taskInputEl.focus();
            }, 700);
        }

        // --- FIREBASE SETUP & AUTHENTICATION ---

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                await setPersistence(auth, browserSessionPersistence);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authReady = true;
                        startTaskListener();
                        // Hide splash screen only after successful auth and data start
                        setTimeout(hideSplashScreen, 2500); // Ensures a minimum display time for the splash screen
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'Not authenticated';
                        signInAnonymously(auth).catch(error => {
                            console.error("Anonymous sign-in failed:", error);
                            showStatus('Failed to sign in.', true);
                        });
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatus('App failed to initialize.', true);
                hideSplashScreen();
            }
        }

        // --- FIRESTORE OPERATIONS ---

        function getTaskCollectionRef() {
            if (!userId) throw new Error("User ID is not available.");
            return collection(db, `artifacts/${appId}/users/${userId}/clem_todos`);
        }

        function startTaskListener() {
            if (unsubscribeTasks) unsubscribeTasks();

            try {
                const q = query(getTaskCollectionRef());

                unsubscribeTasks = onSnapshot(q, (snapshot) => {
                    const tasks = [];
                    snapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    // Sort: undone tasks first, then by timestamp (newest first)
                    tasks.sort((a, b) => {
                        if (a.done !== b.done) return a.done ? 1 : -1;
                        return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
                    });

                    renderTasks(tasks);
                }, (error) => {
                    console.error("Error listening to tasks:", error);
                    showStatus('Real-time data failed to load.', true);
                });
            } catch (e) {
                console.error("Failed to start task listener:", e);
            }
        }

        async function addTask(text) {
            if (!db || !userId || !authReady) {
                showStatus('App still loading...', true);
                return;
            }
            const cleanText = text.trim();
            if (cleanText === '') {
                showStatus('Task cannot be empty.', true);
                return;
            }

            addTaskBtn.disabled = true;

            try {
                await addDoc(getTaskCollectionRef(), {
                    text: cleanText,
                    done: false,
                    timestamp: serverTimestamp()
                });
                taskInputEl.value = '';
                taskInputEl.focus();
            } catch (e) {
                console.error("Error adding document: ", e);
                showStatus('Failed to add task.', true);
            } finally {
                addTaskBtn.disabled = false;
            }
        }

        async function toggleTask(taskId, isDone) {
            if (!db || !userId) return;

            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/clem_todos`, taskId);
                await updateDoc(taskRef, { done: !isDone });
            } catch (e) {
                console.error("Error toggling task: ", e);
                showStatus('Failed to update task status.', true);
            }
        }

        async function deleteTask(taskId) {
            if (!db || !userId) return;

            try {
                const taskRef = doc(db, `artifacts/${appId}/users/${userId}/clem_todos`, taskId);
                await deleteDoc(taskRef);
            } catch (e) {
                console.error("Error deleting task: ", e);
                showStatus('Failed to delete task.', true);
            }
        }

        // --- CLEM BOT (GEMINI API) INTEGRATION ---

        function renderClemBotSuggestion(taskText) {
            clemBotOutput.innerHTML = `
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between bg-violet-100 p-3 rounded-lg border border-violet-200">
                    <p class="text-sm font-semibold text-violet-800 mb-2 md:mb-0">${taskText}</p>
                    <button id="acceptTaskBtn" data-task-text="${taskText}"
                            class="text-xs bg-violet-600 hover:bg-violet-700 text-white font-semibold py-1.5 px-3 rounded-full transition duration-150 transform active:scale-95">
                        Add to List
                    </button>
                </div>
            `;
            document.getElementById('acceptTaskBtn').addEventListener('click', (e) => {
                addTask(e.target.dataset.taskText);
                clemBotOutput.innerHTML = '<p>Click \'Suggest Task\' to get a new idea from Clem Bot.</p>';
            });
        }

        async function generateClemBotTask() {
            if (!authReady) {
                showStatus('App still authenticating. Please wait.', true);
                return;
            }

            clemBotTrigger.disabled = true;
            clemBotOutput.innerHTML = `
                <div class="flex items-center justify-center p-3">
                    <div class="dot-spinner mr-3"></div>
                    <span class="text-violet-600">Clem Bot is thinking...</span>
                </div>
            `;

            const systemPrompt = "You are Clem Bot, a helpful and slightly mischievous assistant for a to-do list app. Generate one highly specific, fun, or self-improvement-focused task suggestion for the user. Do not include introductory phrases, markdown, or punctuation. Only return the task text, nothing else. The task must be concise.";
            const userQuery = "Suggest a new, unique task for the user's to-do list.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiKey = ""; // Canvas will provide this

            // Implement exponential backoff for retries
            const maxRetries = 3;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                        if (text) {
                            renderClemBotSuggestion(text.trim().replace(/^['"]|['"]$/g, ''));
                        } else {
                            clemBotOutput.innerHTML = '<p class="text-red-500">Bot failed to generate text. Try again.</p>';
                        }
                        return; // Success, exit loop
                    } else if (response.status === 429 && i < maxRetries - 1) {
                        // Too many requests, retry with exponential backoff
                        await new Promise(resolve => setTimeout(resolve, currentDelay));
                        currentDelay *= 2;
                        continue;
                    } else {
                        throw new Error(`API Error: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    clemBotOutput.innerHTML = '<p class="text-red-500">Clem Bot connection failed. Check console.</p>';
                    break; // Error, exit loop
                } finally {
                    clemBotTrigger.disabled = false;
                }
            }
        }

        // --- UI RENDERING ---

        function renderTasks(tasks) {
            loadingIndicator.classList.add('hidden');
            taskListEl.innerHTML = '';

            if (tasks.length === 0) {
                taskListEl.innerHTML = '<p class="text-center text-gray-500 py-6 text-sm">All clear! Clem Bot or add a task above.</p>';
                return;
            }

            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 rounded-xl shadow-sm transition duration-150 ${task.done ? 'bg-green-100/50' : 'bg-white hover:bg-indigo-50'} border border-gray-100`;
                item.dataset.taskId = task.id;

                const leftContent = document.createElement('div');
                leftContent.className = 'flex items-center flex-grow min-w-0';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.done;
                checkbox.className = 'w-5 h-5 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 mr-4 cursor-pointer flex-shrink-0';

                const textSpan = document.createElement('span');
                textSpan.textContent = task.text;
                textSpan.className = `min-w-0 break-words text-base ${task.done ? 'task-done text-gray-400' : 'text-gray-800'} transition-all duration-150`;

                leftContent.appendChild(checkbox);
                leftContent.appendChild(textSpan);

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 delete-btn transition-colors" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>`;
                deleteButton.className = 'p-1 ml-4 flex-shrink-0';
                deleteButton.dataset.action = 'delete';

                item.appendChild(leftContent);
                item.appendChild(deleteButton);
                taskListEl.appendChild(item);
            });
        }


        // --- EVENT LISTENERS & INITIALIZATION ---

        addTaskBtn.addEventListener('click', () => {
            addTask(taskInputEl.value);
        });

        taskInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask(taskInputEl.value);
            }
        });

        clemBotTrigger.addEventListener('click', generateClemBotTask);

        taskListEl.addEventListener('click', (e) => {
            const itemEl = e.target.closest('[data-task-id]');
            if (!itemEl) return;

            const taskId = itemEl.dataset.taskId;

            if (e.target.type === 'checkbox') {
                toggleTask(taskId, e.target.checked);
            }

            if (e.target.closest('[data-action="delete"]')) {
                deleteTask(taskId);
            }
        });

        // Start the application
        initFirebase();
    </script>
</body>
</html>

